# Отчет о развертывании D-Sprint-2

**Дата развертывания:** [ДАТА И ВРЕМЯ]  
**Версия спринта:** D-Sprint-2  
**Сервер:** 92.255.78.249  
**Исполнитель:** [ИМЯ]

---

## Цель спринта

Создать пошаговую инструкцию для ручного развертывания приложения на production сервере и выполнить развертывание.

---

## Подготовительный этап

### ✅ Созданные файлы и документация

- [x] `env.production` - шаблон переменных окружения с описаниями
- [x] `docker-compose.prod.yml` - адаптирован под порты 3003, 8003
- [x] `devops/doc/guides/manual-deploy.md` - детальная инструкция развертывания

### ✅ Конфигурация

**Порты:**
- API: 8003 (внешний) → 8000 (внутренний)
- Frontend: 3003 (внешний) → 3000 (внутренний)
- PostgreSQL: 5432 (внутренний)

**NEXT_PUBLIC_API_URL:**
```
http://92.255.78.249:8003
```

**Docker образы:**
- `ghcr.io/yangdeniz/homeguru-bot:latest`
- `ghcr.io/yangdeniz/homeguru-api:latest`
- `ghcr.io/yangdeniz/homeguru-frontend:latest`
- `postgres:16-alpine`

---

## Процесс развертывания

### 1. Подготовка локально

**Статус:** [✅ / ⏳ / ❌]

**Выполненные действия:**
```bash
# Создание .env файла
[ВСТАВИТЬ КОМАНДЫ И РЕЗУЛЬТАТ]

# Заполнение переменных окружения
[ОПИСАТЬ КАКИЕ ПЕРЕМЕННЫЕ БЫЛИ ЗАПОЛНЕНЫ]
```

**Использованные секреты:**
- [x] `ADMIN_PASSWORD` - создан сильный пароль
- [x] `JWT_SECRET_KEY` - сгенерирован случайный ключ (32+ символов)
- [x] `OPENROUTER_API_KEY` - добавлен API ключ
- [x] `TELEGRAM_BOT_TOKEN` - добавлен токен бота

**Проблемы:** [ОПИСАТЬ ЕСЛИ БЫЛИ]

---

### 2. Подключение к серверу

**Статус:** [✅ / ⏳ / ❌]

**Команда подключения:**
```bash
ssh -i [ПУТЬ_К_КЛЮЧУ] systech@92.255.78.249
```

**Проверка установленного ПО:**
```bash
# Docker версия
docker --version
[ВСТАВИТЬ ВЫВОД]

# Docker Compose версия
docker compose version
[ВСТАВИТЬ ВЫВОД]
```

**Создание рабочей директории:**
```bash
mkdir -p /opt/systech/sunko
cd /opt/systech/sunko
```

**Проблемы:** [ОПИСАТЬ ЕСЛИ БЫЛИ]

---

### 3. Копирование файлов на сервер

**Статус:** [✅ / ⏳ / ❌]

**Скопированные файлы:**
```bash
# docker-compose.prod.yml
scp -i [ПУТЬ_К_КЛЮЧУ] docker-compose.prod.yml systech@92.255.78.249:/opt/systech/sunko/
[РЕЗУЛЬТАТ]

# .env
scp -i [ПУТЬ_К_КЛЮЧУ] .env systech@92.255.78.249:/opt/systech/sunko/.env
[РЕЗУЛЬТАТ]
```

**Проверка на сервере:**
```bash
ls -la /opt/systech/sunko/
[ВСТАВИТЬ ВЫВОД]
```

**Проблемы:** [ОПИСАТЬ ЕСЛИ БЫЛИ]

---

### 4. Загрузка Docker образов

**Статус:** [✅ / ⏳ / ❌]

**Команда:**
```bash
docker compose -f docker-compose.prod.yml pull
```

**Результат:**
```
[ВСТАВИТЬ ПОЛНЫЙ ВЫВОД КОМАНДЫ]
```

**Загруженные образы:**
```bash
docker images | grep homeguru
[ВСТАВИТЬ ВЫВОД]
```

**Время загрузки:** [X минут]

**Проблемы:** [ОПИСАТЬ ЕСЛИ БЫЛИ]

---

### 5. Запуск сервисов

**Статус:** [✅ / ⏳ / ❌]

**Команда запуска:**
```bash
docker compose -f docker-compose.prod.yml up -d
```

**Результат:**
```
[ВСТАВИТЬ ПОЛНЫЙ ВЫВОД КОМАНДЫ]
```

**Статус контейнеров:**
```bash
docker compose -f docker-compose.prod.yml ps
[ВСТАВИТЬ ВЫВОД]
```

**Время запуска:** [X секунд/минут]

**Проблемы:** [ОПИСАТЬ ЕСЛИ БЫЛИ]

---

### 6. Проверка миграций базы данных

**Статус:** [✅ / ⏳ / ❌]

**Логи API (миграции):**
```bash
docker compose -f docker-compose.prod.yml logs api | grep -A 20 "Running database migrations"
[ВСТАВИТЬ ВЫВОД]
```

**Проверка таблиц в БД:**
```bash
docker exec -it homeguru-postgres psql -U homeguru -d homeguru -c "\dt"
[ВСТАВИТЬ ВЫВОД]
```

**Созданные таблицы:**
- [ ] `users`
- [ ] `messages`
- [ ] `alembic_version`

**Проблемы:** [ОПИСАТЬ ЕСЛИ БЫЛИ]

---

## Проверка работоспособности

### 7. Проверка всех сервисов

#### PostgreSQL

**Статус:** [✅ / ⏳ / ❌]

```bash
docker compose -f docker-compose.prod.yml logs postgres | tail -20
[ВСТАВИТЬ ВЫВОД]
```

**Healthcheck:**
```bash
docker inspect homeguru-postgres | grep -A 5 '"Health"'
[ВСТАВИТЬ ВЫВОД]
```

---

#### API

**Статус:** [✅ / ⏳ / ❌]

**Логи запуска:**
```bash
docker compose -f docker-compose.prod.yml logs api | tail -30
[ВСТАВИТЬ ВЫВОД]
```

**Проверка локально на сервере:**
```bash
curl http://localhost:8003/
[ВСТАВИТЬ ВЫВОД]
```

**Проверка снаружи (с локального компьютера):**
```bash
curl http://92.255.78.249:8003/
[ВСТАВИТЬ ВЫВОД]
```

**Healthcheck:**
```bash
docker inspect homeguru-api | grep -A 5 '"Health"'
[ВСТАВИТЬ ВЫВОД]
```

**API эндпоинты:**
- [ ] `GET /` - возвращает welcome message
- [ ] `GET /docs` - доступна документация Swagger
- [ ] `GET /health` - healthcheck endpoint (если есть)

---

#### Frontend

**Статус:** [✅ / ⏳ / ❌]

**Логи запуска:**
```bash
docker compose -f docker-compose.prod.yml logs frontend | tail -30
[ВСТАВИТЬ ВЫВОД]
```

**Проверка в браузере:**
- URL: http://92.255.78.249:3003
- Статус: [✅ Доступен / ❌ Недоступен]
- Скриншот: [ПРИКРЕПИТЬ ЕСЛИ ВОЗМОЖНО]

**Проверка подключения к API:**
- [ ] Frontend успешно обращается к API
- [ ] Нет ошибок в консоли браузера (F12 → Console)

---

#### Bot

**Статус:** [✅ / ⏳ / ❌]

**Логи запуска:**
```bash
docker compose -f docker-compose.prod.yml logs bot | tail -30
[ВСТАВИТЬ ВЫВОД]
```

**Проверка подключения к Telegram:**
- [ ] Бот успешно подключился к Telegram API
- [ ] Бот отвечает на команды в Telegram

---

### 8. Финальный статус

**Все контейнеры запущены:**
```bash
docker compose -f docker-compose.prod.yml ps
[ВСТАВИТЬ ФИНАЛЬНЫЙ СТАТУС ВСЕХ КОНТЕЙНЕРОВ]
```

**Статистика ресурсов:**
```bash
docker stats --no-stream
[ВСТАВИТЬ ВЫВОД]
```

**Использование диска:**
```bash
df -h
docker system df
[ВСТАВИТЬ ВЫВОД]
```

---

## Итоговый чек-лист

- [ ] Все 4 контейнера запущены (статус `Up`)
- [ ] PostgreSQL принимает подключения
- [ ] Миграции базы данных выполнены успешно
- [ ] API доступен локально: `http://localhost:8003/`
- [ ] API доступен снаружи: `http://92.255.78.249:8003/`
- [ ] Frontend открывается в браузере: `http://92.255.78.249:3003`
- [ ] Bot подключился к Telegram
- [ ] Нет критических ошибок в логах
- [ ] Healthcheck API возвращает `healthy`
- [ ] В базе данных созданы все таблицы
- [ ] Создан администратор (из ADMIN_USERNAME/ADMIN_PASSWORD)

---

## Проблемы и их решения

### Проблема 1: [НАЗВАНИЕ]

**Описание:**
[ДЕТАЛЬНОЕ ОПИСАНИЕ ПРОБЛЕМЫ]

**Решение:**
[КАК БЫЛА РЕШЕНА]

**Команды:**
```bash
[КОМАНДЫ ДЛЯ РЕШЕНИЯ]
```

---

### Проблема 2: [НАЗВАНИЕ]

**Описание:**
[ДЕТАЛЬНОЕ ОПИСАНИЕ ПРОБЛЕМЫ]

**Решение:**
[КАК БЫЛА РЕШЕНА]

**Команды:**
```bash
[КОМАНДЫ ДЛЯ РЕШЕНИЯ]
```

---

## Выводы и рекомендации

### Что прошло хорошо

- [ПЕРЕЧИСЛИТЬ]

### Что можно улучшить

- [ПЕРЕЧИСЛИТЬ]

### Рекомендации для D-Sprint-3 (Auto Deploy)

1. **Автоматизация через GitHub Actions:**
   - [РЕКОМЕНДАЦИИ]

2. **Безопасность:**
   - [РЕКОМЕНДАЦИИ]

3. **Мониторинг:**
   - [РЕКОМЕНДАЦИИ]

4. **Бэкапы:**
   - [РЕКОМЕНДАЦИИ]

---

## Приложения

### Конфигурация .env (без секретов)

```env
DATABASE_URL=postgresql+asyncpg://homeguru:homeguru_dev@postgres:5432/homeguru
COLLECTOR_MODE=real
ADMIN_USERNAME=admin
ADMIN_PASSWORD=***СКРЫТО***
JWT_SECRET_KEY=***СКРЫТО***
JWT_ACCESS_TOKEN_EXPIRE_DAYS=30
OPENROUTER_API_KEY=***СКРЫТО***
OPENROUTER_MODEL=anthropic/claude-3.5-sonnet
LLM_MODEL=anthropic/claude-3.5-sonnet
TELEGRAM_BOT_TOKEN=***СКРЫТО***
NEXT_PUBLIC_API_URL=http://92.255.78.249:8003
```

### Версии образов

```bash
# Выполнить на сервере:
docker images | grep homeguru

[ВСТАВИТЬ ВЫВОД С ПОЛНЫМИ SHA и датами]
```

---

## Заключение

**Общий статус развертывания:** [✅ УСПЕШНО / ⚠️ С ПРОБЛЕМАМИ / ❌ НЕУСПЕШНО]

**Общее время развертывания:** [X минут]

**Дата завершения:** [ДАТА И ВРЕМЯ]

---

**Подпись:** [ИМЯ]  
**Следующий шаг:** D-Sprint-3 - Auto Deploy

