# ADR-01: Архитектура HomeGuru MVP - ИИ-дизайнер интерьеров с мультимодальностью

**Дата:** 2025-10-10  
**Статус:** Принято (Accepted)  
**Авторы:** Команда разработки  

---

## Контекст

При разработке MVP HomeGuru - специализированного ИИ-дизайнера интерьеров для Telegram необходимо выбрать архитектурный подход, который обеспечит:

- Быстрый запуск и валидацию концепции
- Минимальную сложность реализации и поддержки
- Достаточную функциональность для проверки гипотезы продукта
- Мультимодальные возможности (текст, фото, аудио)
- Мониторинг качества работы ИИ-дизайнера
- Возможность последующей эволюции к более сложной архитектуре

Проект находится на стадии MVP, основная цель — проверить востребованность специализированного ИИ-дизайнера интерьеров с возможностью анализа фотографий, обработки голосовых сообщений и профессиональных консультаций по дизайну.

## Решение

Выбрана **минималистичная монолитная архитектура** с хранением контекста диалогов в оперативной памяти (In-Memory) и мультимодальными возможностями для работы с текстом, изображениями и аудио.

### Архитектурные принципы

#### 1. Монолитное приложение
Все компоненты системы реализованы в рамках одного приложения без разделения на микросервисы или отдельные модули.

#### 2. In-Memory хранилище контекста
Контекст диалогов пользователей хранится в оперативной памяти процесса в виде словаря:
- Ключ: идентификатор пользователя Telegram
- Значение: массив сообщений

#### 3. Polling вместо Webhooks
Бот использует long polling для получения обновлений от Telegram вместо webhook'ов, что упрощает развертывание и не требует публичного URL.

#### 4. Синхронная обработка сообщений
Каждое входящее сообщение обрабатывается последовательно без использования очередей или фоновых задач.

#### 5. Отсутствие персистентности
История диалогов не сохраняется между перезапусками приложения.

#### 6. Мультимодальная LLM
Использование модели с поддержкой Vision API для анализа фотографий интерьеров через OpenRouter.

#### 7. Speech-to-Text для голосовых сообщений
Интеграция распознавания речи для удобства взаимодействия с пользователем.

#### 8. Мониторинг через LangSmith
Автоматический трейсинг всех запросов к LLM для отслеживания качества консультаций ИИ-дизайнера.

#### 9. Системный промпт в отдельном файле
Роль HomeGuru (ИИ-дизайнер интерьеров) определяется через системный промпт, хранящийся в файле `system_prompt.txt` для удобства редактирования.

### Схема архитектуры

```
┌────────────────────────────────────────────────────────────────┐
│                   Пользователь (HomeGuru User)                 │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            │ Текст / Фото / Голосовое сообщение
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                      Telegram API                              │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            │ Long Polling
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                    TelegramBot (bot.py)                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  - Получение сообщений: текст, фото, аудио (polling)    │  │
│  │  - Маршрутизация команд (/start, /help, /reset, /role)  │  │
│  │  - Обработка мультимодальных сообщений                  │  │
│  │  - Отправка ответов пользователям                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────┬────────────────────┬──────────────────┬────────────────┘
        │                    │                  │
        │ Команда            │ Фото/Аудио       │ Текст
        ▼                    ▼                  ▼
┌───────────────┐   ┌────────────────────┐   ┌──────────────────┐
│  Обработка    │   │  MediaProcessor    │   │  DialogueManager │
│  команд       │   │  (media_processor) │   │                  │
│  - /start →   │   │  ┌──────────────┐  │   │ ┌──────────────┐ │
│    HomeGuru   │   │  │ Скачивание   │  │   │ │ In-Memory    │ │
│  - /role →    │   │  │ фото из TG   │  │   │ │ Storage      │ │
│    О дизайне  │   │  │              │  │   │ │ ┌──────────┐ │ │
│  - /help →    │   │  │ Транскрибация│  │   │ │ │ user_id: │ │ │
│    Справка    │   │  │ аудио → текст│  │   │ │ │ [msgs..] │ │ │
│  - /reset →   │   │  │              │  │   │ │ └──────────┘ │ │
│    Очистка    │   │  │ Конвертация  │  │   │ │              │ │
└───────────────┘   │  │ в base64     │  │   │ │ Контекст +   │ │
                    │  └──────────────┘  │   │ │ медиа        │ │
                    └────────┬───────────┘   └─┬──────────────┘ │
                             │                  │                │
                             │ Обработанные     │ История +      │
                             │ медиа            │ новое сообщение│
                             └──────────┬───────┘                │
                                        ▼                        │
                             ┌──────────────────────────────┐    │
                             │  Config (config.py)          │    │
                             │  ┌────────────────────────┐  │    │
                             │  │ Environment Variables  │  │    │
                             │  │ - TELEGRAM_BOT_TOKEN  │  │    │
                             │  │ - OPENROUTER_API_KEY  │  │    │
                             │  │ - OPENROUTER_MODEL    │  │    │
                             │  │ - LANGSMITH_API_KEY   │  │    │
                             │  │ - LANGSMITH_PROJECT   │  │    │
                             │  │ - MAX_HISTORY_MESSAGES│  │    │
                             │  └────────────────────────┘  │    │
                             │  ┌────────────────────────┐  │    │
                             │  │ system_prompt.txt      │  │    │
                             │  │ (Роль HomeGuru)        │  │    │
                             │  └────────────────────────┘  │    │
                             └──────────┬───────────────────┘    │
                                        │                        │
                                        │ Конфигурация + Промпт  │
                                        ▼                        │
                             ┌──────────────────────────────────┐│
                             │   LLMClient (llm_client.py)      ││
                             │  ┌────────────────────────────┐  ││
                             │  │ Формирование запроса       │  ││
                             │  │ - System Prompt (файл)     │  ││
                             │  │ - История диалога          │  ││
                             │  │ - Мультимодальный контент  │  ││
                             │  │   (текст + изображения)    │  ││
                             │  └────────────────────────────┘  ││
                             │  ┌────────────────────────────┐  ││
                             │  │ OpenRouter API + LangSmith │  ││
                             │  │ - Отправка запроса         │  ││
                             │  │ - Трейсинг в LangSmith     │  ││
                             │  │ - Обработка ответа         │  ││
                             │  └────────────────────────────┘  ││
                             └──────────┬───────────────────────┘│
                                        │                        │
                                        │ API Request (traced)   │
                                        ▼                        │
                             ┌──────────────────────────────────┐│
                             │   OpenRouter API                 ││
                             │   (Мультимодальная LLM + Vision) ││
                             └──────────┬───────────────────────┘│
                                        │                        │
                                        │ Generated Response     │
                                        ▼                        │
                             ┌──────────────────────────────────┐│
                             │    LangSmith                     ││
                             │    (Автоматический трейсинг)     ││
                             └──────────┬───────────────────────┘│
                                        │                        │
                                        ▼                        │
                             ┌──────────────────────────────────┐│
                             │    DialogueManager               ││
                             │  - Сохранение ответа в историю   ││
                             └──────────┬───────────────────────┘│
                                        │                        │
                                        │ Ответ HomeGuru         │
                                        ▼                        │
                             ┌──────────────────────────────────┐│
                             │   TelegramBot                    ││
                             │  - Отправка консультации по      ││
                             │    дизайну интерьера             ││
                             └──────────┬───────────────────────┘│
                                        │                        │
                                        │ Send Message           │
                                        ▼                        │
                             ┌──────────────────────────────────┐│
                             │      Telegram API                ││
                             └──────────┬───────────────────────┘│
                                        │                        │
                                        ▼                        │
                             ┌──────────────────────────────────┐│
                             │       Пользователь               ││
                             └──────────────────────────────────┘│

Легенда:
  ┌─┐  - Компонент системы
  │    - Поток данных
  ▼    - Направление потока
```

### Основные компоненты

#### TelegramBot (bot.py)
Компонент, отвечающий за:
- Получение входящих сообщений от пользователей через polling (текст, фото, аудио)
- Маршрутизацию команд: /start, /role, /help, /reset
- Обработку мультимодальных сообщений
- Отправку ответов пользователям
- Управление состоянием соединения с Telegram API

#### MediaProcessor (media_processor.py)
Компонент обработки мультимедиа:
- Скачивание фотографий из Telegram
- Конвертация изображений в base64 для передачи в LLM
- Скачивание голосовых сообщений
- Транскрибация аудио в текст (Speech-to-Text)
- Формирование мультимодальных сообщений

#### DialogueManager (dialogue_manager.py)
Компонент управления контекстом диалога:
- Хранение истории сообщений для каждого пользователя в памяти
- Поддержка мультимодальных сообщений (текст + изображения)
- Ограничение размера контекста (последние N сообщений)
- Предоставление контекста для формирования запроса к LLM

#### LLMClient (llm_client.py)
Клиент для интеграции с мультимодальной языковой моделью:
- Формирование запросов к OpenRouter API (мультимодальная модель с Vision)
- Включение системного промпта HomeGuru из файла
- Поддержка мультимодальных запросов (текст + изображения)
- Интеграция с LangSmith для автоматического трейсинга
- Обработка ответов и ошибок
- Использование openai client с base_url на OpenRouter

#### Config (config.py)
Управление конфигурацией приложения:
- Загрузка параметров из переменных окружения (.env)
- Загрузка системного промпта HomeGuru из файла `system_prompt.txt`
- Хранение API ключей: Telegram, OpenRouter, LangSmith
- Настройки поведения контекста (размер истории)
- Параметры LLM модели

### Поток обработки сообщений

#### Текстовое сообщение:
1. Пользователь отправляет текст в Telegram
2. TelegramBot получает сообщение через long polling
3. DialogueManager извлекает историю диалога пользователя
4. Формируется полный контекст (системный промпт HomeGuru из файла + история + новое сообщение)
5. LLMClient отправляет запрос к OpenRouter API с автоматическим трейсингом в LangSmith
6. Полученный ответ добавляется в контекст
7. TelegramBot отправляет консультацию по дизайну интерьера пользователю

#### Фотография интерьера:
1. Пользователь отправляет фото комнаты в Telegram
2. TelegramBot получает изображение
3. MediaProcessor скачивает и конвертирует фото в base64
4. DialogueManager добавляет мультимодальное сообщение в историю
5. LLMClient формирует запрос с изображением (Vision API)
6. HomeGuru анализирует интерьер и дает рекомендации
7. Ответ отправляется пользователю с трейсингом в LangSmith

#### Голосовое сообщение:
1. Пользователь отправляет аудио в Telegram
2. TelegramBot получает голосовое сообщение
3. MediaProcessor скачивает и транскрибирует аудио в текст
4. Обрабатывается как обычное текстовое сообщение
5. Ответ отправляется пользователю

#### Команды:
- `/start` - приветствие от имени HomeGuru - ИИ-дизайнера интерьеров
- `/role` - отображение роли и специализации HomeGuru
- `/reset` - очистка истории диалога
- `/help` - справка о командах и возможностях

### Управление ресурсами

#### Ограничение контекста
- Максимальное количество сообщений в истории: 10 пар вопрос-ответ (20 сообщений)
- При превышении лимита удаляются самые старые сообщения
- Сохраняется принцип FIFO (First In, First Out)

#### Обработка ошибок
- При ошибках API LLM пользователю отправляется дружественное сообщение
- Ошибки логируются для последующего анализа
- Контекст диалога сохраняется даже при ошибках

### Структура проекта

Проект организован как простое монолитное приложение с четким разделением ответственности:

**Основные директории:**
- **`src/bot/`** - основной код приложения (6 модулей + системный промпт)
- **`tests/`** - юнит-тесты для всех компонентов
- **`docs/`** - документация проекта (концепция, видение, план, ADR)

**Ключевые модули бота:**
- `TelegramBot` - интерфейс взаимодействия с пользователями
- `MediaProcessor` - обработка фотографий и аудио
- `DialogueManager` - управление контекстом диалогов (in-memory)
- `LLMClient` - интеграция с мультимодальной LLM + LangSmith
- `Config` - конфигурация из .env + загрузка системного промпта
- `system_prompt.txt` - роль HomeGuru (ИИ-дизайнер интерьеров)

> **Примечание:** Детальная структура файлов и полное описание модулей представлены в [vision.md](../vision.md#3-структура-проекта).

## Последствия

### Положительные

#### Скорость разработки
Минимальная архитектура позволяет реализовать MVP за несколько часов работы, что критично для быстрой валидации идеи.

#### Простота понимания
Вся логика приложения находится в одном месте, что упрощает онбординг новых разработчиков и отладку.

#### Низкие требования к инфраструктуре
Приложение может работать на любом сервере или даже локальной машине без необходимости настройки баз данных, очередей сообщений или других сервисов.

#### Минимальные операционные издержки
Не требуется администрирование БД, мониторинг нескольких сервисов, управление миграциями данных.

#### Быстрое время отклика
Отсутствие обращений к БД минимизирует задержки, все данные читаются из памяти за микросекунды.

#### Нулевые затраты на хранение
Отсутствие базы данных исключает расходы на хранение и резервное копирование данных.

### Отрицательные

#### Потеря данных при перезапуске
Вся история диалогов теряется при остановке или перезапуске приложения. Пользователям придется начинать диалог заново.

**Митигация**: LangSmith сохраняет все запросы и ответы для последующего анализа, даже если локальная история потеряна.

#### Ограниченная масштабируемость
Невозможность горизонтального масштабирования — можно запустить только один экземпляр приложения, так как контекст хранится локально.

#### Ограничения по памяти
При большом количестве одновременных пользователей потребление оперативной памяти может стать критичным.

**Митигация**: Жесткие лимиты на размер истории; мультимодальные сообщения с изображениями ограничены.

#### Стоимость мультимодальных запросов
Использование Vision API и Speech-to-Text увеличивает стоимость каждого запроса.

**Митигация**: Мониторинг использования через LangSmith; оптимизация размера изображений.

#### Невозможность восстановления сессий
При сбое сервера пользователи теряют контекст и должны повторно объяснять контекст своего запроса.

#### Отсутствие персонализации
Нет возможности сохранять долгосрочные предпочтения или информацию о пользователе между сессиями.

**Примечание**: LangSmith обеспечивает аналитику и возможность анализа качества консультаций HomeGuru, что частично компенсирует отсутствие локального хранения.

### Риски и их митигация

#### Риск: Потеря данных критична для пользователей
**Митигация:** Четкое информирование пользователей о временном характере истории; команда для ручной очистки контекста.

#### Риск: Превышение лимитов памяти
**Митигация:** Жесткие лимиты на размер истории; мониторинг использования памяти.

#### Риск: Невозможность масштабирования при росте
**Митигация:** Архитектура спроектирована так, чтобы миграция к БД требовала изменений только в модуле DialogueManager.

## Критерии успеха

Данная архитектура считается успешной, если:

1. MVP HomeGuru запущен и работает стабильно для первых пользователей
2. Подтверждена гипотеза о востребованности ИИ-дизайнера интерьеров
3. Успешная обработка мультимодальных запросов (текст, фото, аудио)
4. LangSmith собирает данные о качестве консультаций для оптимизации
5. Собрана обратная связь для определения направления развития
6. Среднее время отклика бота не превышает 5 секунд (с учетом Vision API)
7. Приложение стабильно работает при нагрузке до 50 одновременных пользователей
8. Пользователи получают полезные рекомендации по дизайну интерьеров

