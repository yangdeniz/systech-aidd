# ADR-01: Минималистичная архитектура с In-Memory хранилищем

**Дата:** 2025-10-10  
**Статус:** Принято (Accepted)  
**Авторы:** Команда разработки  

---

## Контекст

При разработке MVP LLM-ассистента для Telegram необходимо выбрать архитектурный подход, который обеспечит:

- Быстрый запуск и валидацию концепции
- Минимальную сложность реализации и поддержки
- Достаточную функциональность для проверки гипотезы продукта
- Возможность последующей эволюции к более сложной архитектуре

Проект находится на стадии MVP, основная цель — проверить востребованность и функциональность базового взаимодействия пользователя с LLM через Telegram-бот.

## Решение

Выбрана **минималистичная монолитная архитектура** с хранением контекста диалогов в оперативной памяти (In-Memory).

### Архитектурные принципы

#### 1. Монолитное приложение
Все компоненты системы реализованы в рамках одного приложения без разделения на микросервисы или отдельные модули.

#### 2. In-Memory хранилище контекста
Контекст диалогов пользователей хранится в оперативной памяти процесса в виде словаря:
- Ключ: идентификатор пользователя Telegram
- Значение: массив сообщений и метаданные (временная метка последнего обновления)

#### 3. Polling вместо Webhooks
Бот использует long polling для получения обновлений от Telegram вместо webhook'ов, что упрощает развертывание и не требует публичного URL.

#### 4. Синхронная обработка сообщений
Каждое входящее сообщение обрабатывается последовательно без использования очередей или фоновых задач.

#### 5. Отсутствие персистентности
История диалогов не сохраняется между перезапусками приложения.

### Схема архитектуры

```
┌────────────────────────────────────────────────────────────────┐
│                         Пользователь                           │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            │ Отправка сообщения
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                      Telegram API                              │
└───────────────────────────┬────────────────────────────────────┘
                            │
                            │ Long Polling
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                    Telegram Bot Handler                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  - Получение сообщений                                   │  │
│  │  - Маршрутизация команд (/start, /help, /clear)         │  │
│  │  - Обработка текстовых сообщений                        │  │
│  │  - Отправка ответов пользователям                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────┬───────────────────────────────┬────────────────┘
                │                               │
                │ Команда                       │ Текстовое сообщение
                ▼                               ▼
    ┌───────────────────────┐     ┌────────────────────────────┐
    │  Обработка команд     │     │    DialogueManager         │
    │  - /start → Привет    │     │  ┌──────────────────────┐  │
    │  - /help → Справка    │     │  │ In-Memory Storage    │  │
    │  - /reset → Очистка   │     │  │ ┌──────────────────┐ │  │
    └───────────────────────┘     │  │ │ user_id: {       │ │  │
                                  │  │ │   messages: [],  │ │  │
                                  │  │ │   timestamp: ... │ │  │
                                  │  │ └──────────────────┘ │  │
                                  │  └──────────────────────┘  │
                                 │                            │
                                 │  - Получение контекста     │
                                 │  - Добавление сообщений    │
                                 │  - Ограничение размера     │
                                 └──────────┬─────────────────┘
                                             │
                                             │ История + новое сообщение
                                             ▼
                                  ┌──────────────────────────────┐
                                  │  Configuration Layer         │
                                  │  ┌────────────────────────┐  │
                                  │  │ Environment Variables  │  │
                                  │  │ - BOT_TOKEN           │  │
                                  │  │ - OPENAI_API_KEY      │  │
                                  │  │ - MODEL_NAME          │  │
                                  │  │ - MAX_HISTORY_MESSAGES│  │
                                  │  └────────────────────────┘  │
                                  └──────────┬───────────────────┘
                                             │
                                             │ Конфигурация
                                             ▼
                                  ┌──────────────────────────────┐
                                  │   LLM Integration Layer      │
                                  │  ┌────────────────────────┐  │
                                  │  │ Формирование запроса   │  │
                                  │  │ - System Prompt        │  │
                                  │  │ - История диалога      │  │
                                  │  │ - Новое сообщение      │  │
                                  │  └────────────────────────┘  │
                                  │                              │
                                  │  ┌────────────────────────┐  │
                                  │  │ Вызов API              │  │
                                  │  │ - Отправка запроса     │  │
                                  │  │ - Обработка ответа     │  │
                                  │  │ - Обработка ошибок     │  │
                                  │  └────────────────────────┘  │
                                  └──────────┬───────────────────┘
                                             │
                                             │ API Request
                                             ▼
                                  ┌──────────────────────────────┐
                                  │   LLM Provider API           │
                                  │   (OpenAI / Anthropic / др.) │
                                  └──────────┬───────────────────┘
                                             │
                                             │ Generated Response
                                             ▼
                                  ┌──────────────────────────────┐
                                  │    DialogueManager           │
                                  │  - Сохранение ответа         │
                                  │  - Обновление timestamp      │
                                  └──────────┬───────────────────┘
                                             │
                                             │ Ответ LLM
                                             ▼
                                  ┌──────────────────────────────┐
                                  │   Telegram Bot Handler       │
                                  │  - Отправка ответа           │
                                  └──────────┬───────────────────┘
                                             │
                                             │ Send Message
                                             ▼
                                  ┌──────────────────────────────┐
                                  │      Telegram API            │
                                  └──────────┬───────────────────┘
                                             │
                                             ▼
                                  ┌──────────────────────────────┐
                                  │       Пользователь           │
                                  └──────────────────────────────┘

Легенда:
  ┌─┐  - Компонент системы
  │    - Поток данных
  ▼    - Направление потока
```

### Основные компоненты

#### Telegram Bot Handler
Компонент, отвечающий за:
- Получение входящих сообщений от пользователей
- Маршрутизацию команд и текстовых сообщений
- Отправку ответов пользователям
- Управление состоянием соединения с Telegram API

#### DialogueManager
Компонент управления контекстом диалога:
- Хранение истории сообщений для каждого пользователя
- Ограничение размера контекста (последние N сообщений)
- Предоставление контекста для формирования запроса к LLM

#### LLM Integration Layer
Слой интеграции с языковой моделью:
- Формирование запросов к API провайдера LLM
- Включение системного промпта и истории диалога
- Обработка ответов и ошибок
- Управление параметрами генерации (температура, максимальная длина)

#### Configuration Layer
Управление конфигурацией приложения:
- Загрузка параметров из переменных окружения
- Хранение API ключей и токенов
- Настройки поведения контекста (размер, время жизни)
- Параметры LLM модели

### Поток обработки сообщений

1. Пользователь отправляет сообщение в Telegram
2. Bot Handler получает сообщение через long polling
3. Проверяется тип сообщения (команда или текст)
4. Для текстовых сообщений:
   - DialogueManager извлекает историю диалога пользователя
   - Формируется полный контекст (системный промпт + история + новое сообщение)
   - LLM Integration Layer отправляет запрос к API
   - Полученный ответ добавляется в контекст
   - Bot Handler отправляет ответ пользователю
5. Для команд выполняется соответствующее действие (очистка контекста, справка и т.д.)

### Управление ресурсами

#### Ограничение контекста
- Максимальное количество сообщений в истории: 10 пар вопрос-ответ (20 сообщений)
- При превышении лимита удаляются самые старые сообщения
- Сохраняется принцип FIFO (First In, First Out)

#### Обработка ошибок
- При ошибках API LLM пользователю отправляется дружественное сообщение
- Ошибки логируются для последующего анализа
- Контекст диалога сохраняется даже при ошибках

### Структура проекта

Проект организован в виде простой модульной структуры:

**Основная директория** содержит исполняемый модуль бота и вспомогательные файлы

**Модуль конфигурации** отвечает за загрузку и предоставление параметров

**Модуль промптов** содержит системные промпты для различных режимов работы

**Файлы зависимостей** описывают требуемые библиотеки

**Конфигурационные файлы** хранят секретные ключи и настройки окружения

## Последствия

### Положительные

#### Скорость разработки
Минимальная архитектура позволяет реализовать MVP за несколько часов работы, что критично для быстрой валидации идеи.

#### Простота понимания
Вся логика приложения находится в одном месте, что упрощает онбординг новых разработчиков и отладку.

#### Низкие требования к инфраструктуре
Приложение может работать на любом сервере или даже локальной машине без необходимости настройки баз данных, очередей сообщений или других сервисов.

#### Минимальные операционные издержки
Не требуется администрирование БД, мониторинг нескольких сервисов, управление миграциями данных.

#### Быстрое время отклика
Отсутствие обращений к БД минимизирует задержки, все данные читаются из памяти за микросекунды.

#### Нулевые затраты на хранение
Отсутствие базы данных исключает расходы на хранение и резервное копирование данных.

### Отрицательные

#### Потеря данных при перезапуске
Вся история диалогов теряется при остановке или перезапуске приложения. Пользователям придется начинать диалог заново.

#### Ограниченная масштабируемость
Невозможность горизонтального масштабирования — можно запустить только один экземпляр приложения, так как контекст хранится локально.

#### Ограничения по памяти
При большом количестве одновременных пользователей потребление оперативной памяти может стать критичным.

#### Отсутствие аналитики
Без сохранения истории невозможно проводить анализ диалогов, оптимизацию промптов, обучение на данных.

#### Невозможность восстановления сессий
При сбое сервера пользователи теряют контекст и должны повторно объяснять контекст своего запроса.

#### Отсутствие персонализации
Нет возможности сохранять долгосрочные предпочтения или информацию о пользователе между сессиями.

### Риски и их митигация

#### Риск: Потеря данных критична для пользователей
**Митигация:** Четкое информирование пользователей о временном характере истории; команда для ручной очистки контекста.

#### Риск: Превышение лимитов памяти
**Митигация:** Жесткие лимиты на размер истории; мониторинг использования памяти.

#### Риск: Невозможность масштабирования при росте
**Митигация:** Архитектура спроектирована так, чтобы миграция к БД требовала изменений только в модуле DialogueManager.

## Критерии успеха

Данная архитектура считается успешной, если:

1. MVP запущен и работает стабильно для первых пользователей
2. Подтверждена гипотеза о востребованности функционала
3. Собрана обратная связь для определения направления развития
4. Среднее время отклика бота не превышает 3 секунд
5. Приложение стабильно работает при нагрузке до 50 одновременных пользователей

