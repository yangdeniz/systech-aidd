# Coding Conventions

> Основано на [vision.md](vision.md) - для полного понимания контекста проекта обратитесь к нему.

## Ключевые принципы

### 1. KISS превыше всего
- Максимальная простота во всём
- Если можно проще — сделай проще
- Код должен быть понятен без документации

### 2. Никакого оверинжиниринга
- Не решаем проблемы, которых еще нет
- Минимум абстракций
- Один модуль = одна ответственность

### 3. Структура кода
- **1 класс = 1 файл** (обязательно)
- Простые и понятные имена классов и методов
- Плоская структура без вложенных пакетов

### 4. MVP-подход
- Только необходимый функционал
- Персистентное хранение (PostgreSQL с Repository pattern)
- Асинхронная обработка через aiogram и SQLAlchemy async
- Никаких дополнительных фич "на будущее"

### 5. Type Safety
- **Type hints обязательны** для всех методов и атрибутов
- Mypy в strict mode (0 ошибок)
- Типизация помогает понять код без документации
- Проверка `Optional` типов (например, `message.from_user is None`)

### 6. SOLID (разумно)
- **Single Responsibility (SRP)** - каждый класс имеет одну ответственность
- **Dependency Inversion (DIP)** - Protocol для ключевых зависимостей
- Не применяем избыточно - только там, где дает реальную пользу
- Protocol проще чем ABC - используем Protocol

## Технические требования

### Python
- Python 3.11+
- **Type hints обязательны** - все методы типизированы
- Стандартная библиотека предпочтительнее внешних зависимостей
- Modern Python syntax (PEP 585: `list[str]` вместо `List[str]`)

### Логирование
- Стандартный `logging` (не сторонние библиотеки)
- Уровни: INFO для событий, ERROR для ошибок
- Логи в файл + консоль

### Конфигурация
- Все настройки через .env
- **Исключение**: системный промпт HomeGuru хранится в файле `system_prompt.txt`
- Один класс Config для загрузки (переменные окружения + промпт из файла)
- Без валидации в MVP (fail fast)

### Обработка ошибок
- В MVP - минимальная обработка
- Логируем ошибки через logger.error()
- Не перехватываем исключения без явной необходимости
- Валидация обязательных параметров (raise ValueError если None)

### Качество кода

**Инструменты (обязательны):**
- **Ruff** - форматтер и линтер (заменяет Black + Flake8 + isort)
- **Mypy** - статическая проверка типов (strict mode)
- **Pytest** - тестирование с покрытием (pytest-cov, pytest-asyncio)

**Требования:**
- Test Coverage ≥ 80%
- Mypy strict mode: 0 errors
- Ruff: 0 critical errors
- Line length: ≤ 100 символов

**Команды проверки:**
```bash
make format     # Автоформатирование
make lint       # Проверка стиля
make typecheck  # Проверка типов
make test       # Тесты с покрытием
make quality    # Все проверки вместе
```

**Type Hints - примеры:**
```python
# ✅ Правильно
def get_history(self, user_id: int) -> list[dict[str, str]]:
    return self.dialogues.get(user_id, [])

# ❌ Неправильно
def get_history(self, user_id):
    return self.dialogues.get(user_id, [])
```

**Protocol для DIP:**
```python
# ✅ Правильно - зависимость от абстракции
from typing import Protocol

class LLMProvider(Protocol):
    def get_response(self, messages: list[dict[str, str]]) -> str: ...

class MessageHandler:
    def __init__(self, llm: LLMProvider):  # Protocol тип
        self.llm = llm

# ❌ Неправильно - зависимость от конкретного класса
class MessageHandler:
    def __init__(self, llm: LLMClient):  # Конкретный класс
        self.llm = llm
```

**Single Responsibility:**
```python
# ✅ Правильно - разделение ответственностей
class TelegramBot:  # Только инфраструктура
    def __init__(self, handler: MessageHandler):
        self.handler = handler

class MessageHandler:  # Только бизнес-логика
    def process(self, text: str) -> str:
        return response

# ❌ Неправильно - множественные ответственности
class TelegramBot:
    # И инфраструктура, И бизнес-логика, И команды - слишком много!
```

## Что НЕ делать

❌ Не создавать вложенные пакеты и модули  
❌ Не использовать сложные паттерны проектирования  
❌ Не добавлять функционал "на будущее"  
❌ Не использовать базы данных  
❌ Не делать асинхронную обработку диалогов  
❌ Не писать избыточную документацию  
❌ Не создавать дополнительные слои абстракции  

## Чек-лист перед коммитом

**Автоматические проверки:**
- [ ] `make format` - пройдено
- [ ] `make lint` - 0 errors
- [ ] `make typecheck` - success (mypy strict)
- [ ] `make test` - все тесты проходят
- [ ] Coverage ≥ 80%

**Ручная проверка:**
- [ ] 1 класс = 1 файл?
- [ ] Код понятен без комментариев?
- [ ] Можно было сделать проще?
- [ ] Все методы типизированы?
- [ ] Новый код покрыт тестами?
- [ ] Логирование добавлено?
- [ ] SOLID применен разумно?

**Перед коммитом - запусти:**
```bash
make quality  # Все проверки сразу
```  

---

**Помни**: Если сомневаешься — выбирай более простое решение.

